filter {

    if [fields][log_type] == "apache_combined" {
        grok {
            match => {
            "message" => '%{IPORHOST:clientip} %{USER:ident} %{USER:auth} \[%{HTTPDATE:timestamp}\] "%{WORD:verb} %{DATA:request} HTTP/%{NUMBER:httpversion}" %{NUMBER:response:int} (?:-|%{NUMBER:bytes:int}) %{QS:referrer} %{QS:agent}'
            }
        }

        date {
            match => [ "timestamp", "dd/MMM/YYYY:HH:mm:ss Z" ]
            locale => en
        }

        if [clientip] =~ /(\d+.\d+.\d+.\d+)/ {
            grok {
                match => {
                "event_message" => [ "%{IP:[src][ip]}" ]
                }
            }
        }

        if [src][ip] {
            cidr {
                address => [ "%{[src[ip]}" ]
                network => [ "0.0.0.0/32", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "fc00::/7", "127.0.0.0/8", "::1/128", "169.254.0.0/16", "fe80::/10","224.0.0.0/4", "ff00::/8","255.255.255.255/32"  ]
                add_field => { "[src][locality]" => "private" }
            }
            if ![src][locality] {
                mutate {
                    add_field => { "[src][locality]" => "public" }
                }
            }
        }

        useragent {
            source => "agent"
            target => "useragent"
        }
    }
}
